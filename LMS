package project2;
import javax.swing.*;
import java.awt.*;
import java.awt.event.*;
import java.sql.*;
import javax.swing.table.DefaultTableModel;
import java.sql.*;

public class LMS extends JFrame {
    private static final String DB_URL = "jdbc:mysql://localhost:3306/lib";
    private static final String DB_USER = "root";
    private static final String DB_PASSWORD = "12345";

    private JTextField titleField, authorField, genreField;
    private JTable table;
    private DefaultTableModel tableModel;

    public LMS() {
        setTitle("Library Management System");
        setSize(800, 400);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);

        JPanel inputPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 10));

        titleField = new JTextField(20);
        authorField = new JTextField(20);
        genreField = new JTextField(20);
        JButton addButton = new JButton("Add Book");
        JButton deleteButton = new JButton("Delete Book");
        JButton searchButton = new JButton("Search Book");
        JButton findSimilarButton = new JButton("Find Similar Books");

        inputPanel.add(new JLabel("Title: "));
        inputPanel.add(titleField);
        inputPanel.add(new JLabel("Author: "));
        inputPanel.add(authorField);
        inputPanel.add(new JLabel("Genre: "));
        inputPanel.add(genreField);

        JPanel buttonPanel = new JPanel();
        buttonPanel.setLayout(new FlowLayout(FlowLayout.RIGHT));
        buttonPanel.add(addButton);
        buttonPanel.add(deleteButton);
        buttonPanel.add(searchButton);
        buttonPanel.add(findSimilarButton);

        tableModel = new DefaultTableModel();
        table = new JTable(tableModel);
        tableModel.addColumn("ID");
        tableModel.addColumn("Title");
        tableModel.addColumn("Author");
        tableModel.addColumn("Genre");

        JScrollPane tableScrollPane = new JScrollPane(table);

        setLayout(new BorderLayout());
        add(inputPanel, BorderLayout.NORTH);
        add(tableScrollPane, BorderLayout.CENTER);
        add(buttonPanel, BorderLayout.SOUTH);

        addButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                addBook();
            }
        });

        deleteButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                deleteBook();
            }
        });

        searchButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                searchBook();
            }
        });

        findSimilarButton.addActionListener(new ActionListener() {
            public void actionPerformed(ActionEvent e) {
                findSimilarBooks();
            }
        });

        try {
            Class.forName("com.mysql.cj.jdbc.Driver");
            Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            Statement statement = connection.createStatement();
            ResultSet resultSet = statement.executeQuery("SELECT * FROM kitab");

            while (resultSet.next()) {
                int id = resultSet.getInt("id");
                String title = resultSet.getString("title");
                String author = resultSet.getString("author");
                String genre = resultSet.getString("genre");
                tableModel.addRow(new Object[] { id, title, author, genre });
            }

            resultSet.close();
            statement.close();
            connection.close();
        } catch (Exception ex) {
            ex.printStackTrace();
        }

        setVisible(true);
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new LMS());
    }

    private void addBook() {
        String title = titleField.getText();
        String author = authorField.getText();
        String genre = genreField.getText();

        try {
            Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            PreparedStatement preparedStatement = connection
                    .prepareStatement("INSERT INTO kitab (title, author, genre) VALUES (?, ?, ?)");
            preparedStatement.setString(1, title);
            preparedStatement.setString(2, author);
            preparedStatement.setString(3, genre);

            int rowsAffected = preparedStatement.executeUpdate();
            if (rowsAffected > 0) {
                tableModel.addRow(new Object[] { getLastInsertedID(connection), title, author, genre });
                titleField.setText("");
                authorField.setText("");
                genreField.setText("");
            }
            preparedStatement.close();
            connection.close();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private void deleteBook() {
        int selectedRow = table.getSelectedRow();
        if (selectedRow != -1) {
            int bookID = (int) tableModel.getValueAt(selectedRow, 0);
            try {
                Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
                PreparedStatement preparedStatement = connection.prepareStatement("DELETE FROM kitab WHERE id = ?");
                preparedStatement.setInt(1, bookID);

                int rowsAffected = preparedStatement.executeUpdate();
                if (rowsAffected > 0) {
                    tableModel.removeRow(selectedRow);
                }
                preparedStatement.close();
                connection.close();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
    }

    private void searchBook() {
        String searchTitle = titleField.getText();
        String searchAuthor = authorField.getText();

        while (tableModel.getRowCount() > 0) {
            tableModel.removeRow(0);
        }

        try {
            Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
            PreparedStatement preparedStatement = connection
                    .prepareStatement("SELECT * FROM kitab WHERE title LIKE ? AND author LIKE ?");
            preparedStatement.setString(1, "%" + searchTitle + "%");
            preparedStatement.setString(2, "%" + searchAuthor + "%");

            ResultSet resultSet = preparedStatement.executeQuery();

            while (resultSet.next()) {
                int id = resultSet.getInt("id");
                String title = resultSet.getString("title");
                String author = resultSet.getString("author");
                String genre = resultSet.getString("genre");
                tableModel.addRow(new Object[] { id, title, author, genre });
            }

            resultSet.close();
            preparedStatement.close();
            connection.close();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private void findSimilarBooks() {
        int selectedRow = table.getSelectedRow();
        if (selectedRow != -1) {
            String selectedGenre = (String) tableModel.getValueAt(selectedRow, 3);

            try {
                Connection connection = DriverManager.getConnection(DB_URL, DB_USER, DB_PASSWORD);
                PreparedStatement preparedStatement = connection
                        .prepareStatement("SELECT * FROM kitab WHERE genre = ?");
                preparedStatement.setString(1, selectedGenre);

                // Clear the table before populating with similar books
                while (tableModel.getRowCount() > 0) {
                    tableModel.removeRow(0);
                }

                ResultSet resultSet = preparedStatement.executeQuery();

                while (resultSet.next()) {
                    int id = resultSet.getInt("id");
                    String title = resultSet.getString("title");
                    String author = resultSet.getString("author");
                    String genre = resultSet.getString("genre");
                    tableModel.addRow(new Object[] { id, title, author, genre });
                }

                resultSet.close();
                preparedStatement.close();
                connection.close();
            } catch (Exception ex) {
                ex.printStackTrace();
            }
        }
    }


    private int getLastInsertedID(Connection connection) throws SQLException {
        PreparedStatement statement = connection.prepareStatement("SELECT LAST_INSERT_ID()");
        ResultSet resultSet = statement.executeQuery();
        resultSet.next();
        return resultSet.getInt(1);
    }
}
